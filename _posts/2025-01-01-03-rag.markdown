---
layout: post
title: "Simple RAG"
category: ""
---

# Simple RAG: LangChain + Ollama + FAISS ã‚’ä½¿ã£ãŸç°¡æ˜“RAGæ§‹æˆ

Ollamaãƒ»LangChainãƒ»FAISSã‚’ä½¿ã„ã€ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§RAGï¼ˆæ¤œç´¢æ‹¡å¼µç”Ÿæˆï¼‰ã‚’æ§‹ç¯‰ã™ã‚‹æ‰‹é †ã‚’ã¾ã¨ã‚ãŸå®Ÿé¨“ã§ã™ã€‚

---

## 1. pyenvã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

Pythonç’°å¢ƒã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ã®ãŸã‚ `pyenv` ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

```sh
sudo yum install gcc zlib-devel bzip2 bzip2-devel readline readline-devel sqlite sqlite-devel openssl openssl-devel git libffi-devel

git clone https://github.com/pyenv/pyenv.git ~/.pyenv

if grep "pyenv init -" ~/.bash_profile ; then
  echo "skip."
else
  echo 'export PATH="$HOME/.pyenv/bin:$PATH"' >> ~/.bash_profile
  echo 'eval "$(pyenv init -)"' >> ~/.bash_profile
fi
source ~/.bash_profile

pyenv install --list
pyver="3.13.5"
pyenv install ${pyver}
pyenv global  ${pyver}
pyenv rehash
````

---

## 2. sqlite3ã®ãƒ“ãƒ«ãƒ‰ï¼ˆChromaDBå¯¾å¿œï¼‰

ChromaDBã‚„FAISSåˆ©ç”¨æ™‚ã®ä¾å­˜ã¨ã—ã¦æœ€æ–°ç‰ˆã® `sqlite3` ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

```sh
curl -O https://www.sqlite.org/2025/sqlite-src-3500200.zip
unzip sqlite-src-3500200.zip
cd sqlite-src-3500200/
./configure && make
sudo make install

export LD_LIBRARY_PATH=/usr/local/lib:$LD_LIBRARY_PATH
```

---

## 3. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹æˆ

RAGãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚

```sh
mkdir rag
cd rag

# å¿…è¦ãªPythonãƒ©ã‚¤ãƒ–ãƒ©ãƒª
cat <<'EOF' > requirements.txt
langchain
ollama
faiss-cpu
langchain-community
langchain-ollama
EOF

pip3.13 install -r requirements.txt
```

---

## 4. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆ

æ¤œç´¢å¯¾è±¡ã¨ãªã‚‹ã‚µãƒ³ãƒ—ãƒ«ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼ˆMarkdownå½¢å¼ï¼‰ã‚’ç”¨æ„ã—ã¾ã™ã€‚

```sh
mkdir docs

cat <<'EOF' > docs/text.md
* çŒ«ã¯ãƒ‹ãƒ£ãƒ¼
* çŠ¬ãªã‚‰ãƒ¯ãƒ³
* è±¡ã¯ãƒ‘ã‚ªãƒ¼ãƒ³
* ãƒ©ã‚¤ã‚ªãƒ³ã‚¬ã‚ªãƒ¼ãƒƒ
* äººé–“ã ã‚‚ã‚“ã‚ã‹ã•ãŸãªã¯ã‚„ã¾ã‚‰ã‚ãŠã‚“
EOF

# ãƒ¢ãƒ‡ãƒ«ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆåŸ‹ã‚è¾¼ã¿ç”¨ã¨ç”Ÿæˆç”¨ï¼‰
ollama pull gemma3n
```

---

## 5. ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼šbuild\_index3.py

RAGã®æ§‹ç¯‰ã¨å•ã„åˆã‚ã›å‡¦ç†ã‚’è¡Œã†Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ã™ã€‚

```python
import glob
from langchain_community.vectorstores import FAISS
from langchain_ollama import OllamaEmbeddings, OllamaLLM
from langchain.text_splitter import CharacterTextSplitter
from langchain_community.document_loaders import TextLoader
from langchain.chains import RetrievalQA

# ---------- è¨­å®š ----------
EMBED_MODEL = "nomic-embed-text"
LLM_MODEL = "gemma3n"
DOC_PATTERN = "docs/*.md"
QUERY = "çŠ¬ã¯ï¼Ÿ"

# ---------- ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆèª­ã¿è¾¼ã¿ ----------
file_paths = glob.glob(DOC_PATTERN)
all_docs = []

for path in file_paths:
    loader = TextLoader(path, encoding="utf-8")
    docs = loader.load()
    for doc in docs:
        doc.metadata["source"] = path
    all_docs.extend(docs)

print(f"âœ… èª­ã¿è¾¼ã‚“ã ãƒ•ã‚¡ã‚¤ãƒ«æ•°: {len(file_paths)}")
print(f"âœ… ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•°: {len(all_docs)}")

# ---------- åˆ†å‰²å‡¦ç† ----------
splitter = CharacterTextSplitter(chunk_size=500, chunk_overlap=50)
split_docs = splitter.split_documents(all_docs)
print(f"âœ… ãƒãƒ£ãƒ³ã‚¯æ•°: {len(split_docs)}")

# ---------- ãƒ™ã‚¯ãƒˆãƒ«ã‚¹ãƒˆã‚¢ä½œæˆ ----------
embedder = OllamaEmbeddings(model=EMBED_MODEL)
vectorstore = FAISS.from_documents(split_docs, embedder)

# ---------- RetrievalQA ----------
retriever = vectorstore.as_retriever(search_kwargs={"k": 3})
llm = OllamaLLM(model=LLM_MODEL)

rag_chain = RetrievalQA.from_chain_type(
    llm=llm,
    retriever=retriever,
    chain_type="stuff",
    return_source_documents=True
)

# ---------- å•ã„åˆã‚ã› ----------
print(f"\nâ“ è³ªå•: {QUERY}")
result = rag_chain.invoke({"query": QUERY})

# ---------- å‡ºåŠ› ----------
print("\nğŸ§  å›ç­”:\n", result["result"])

print("\nğŸ“š å‚ç…§ã‚½ãƒ¼ã‚¹:")
for doc in result["source_documents"]:
    print(f"- {doc.metadata.get('source', 'ä¸æ˜')}")
    print(doc.page_content[:100].replace("\n", " "), "\n---")
```

---

## 6. å®Ÿè¡Œ

```sh
python3.13 build_index3.py
```

---

## 7. å®Ÿè¡Œçµæœï¼ˆä¾‹ï¼‰

```
âœ… èª­ã¿è¾¼ã‚“ã ãƒ•ã‚¡ã‚¤ãƒ«æ•°: 1
âœ… ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•°: 1
âœ… ãƒãƒ£ãƒ³ã‚¯æ•°: 1

â“ è³ªå•: çŠ¬ã¯ï¼Ÿ

ğŸ§  å›ç­”:
 çŠ¬ãªã‚‰ãƒ¯ãƒ³

ğŸ“š å‚ç…§ã‚½ãƒ¼ã‚¹:
- docs/text.md
çŒ«ã¯ãƒ‹ãƒ£ãƒ¼ çŠ¬ãªã‚‰ãƒ¯ãƒ³ è±¡ã¯ãƒ‘ã‚ªãƒ¼ãƒ³ ãƒ©ã‚¤ã‚ªãƒ³ã‚¬ã‚ªãƒ¼ãƒƒ äººé–“ã ã‚‚ã‚“ã‚ã‹ã•ãŸãªã¯ã‚„ã¾ã‚‰ã‚ãŠã‚“ 
---
```
